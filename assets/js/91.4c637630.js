(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{542:function(t,i,a){"use strict";a.r(i);var e=a(15),n=Object(e.a)({},(function(){var t=this,i=t._self._c;return i("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[i("section",{staticStyle:{"font-size":"16px",color:"black",padding:"0px 10px","line-height":"1.6","word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',visibility:"visible"}},[i("h1",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"24px",visibility:"visible"}},[i("span",{staticStyle:{display:"none"}}),i("span",{staticStyle:{"word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[i("img",{staticClass:"rich_pages wxw-img",staticStyle:{visibility:"visible"},attrs:{alt:"已生成图片","data-src":"https://mmbiz.qpic.cn/sz_mmbiz_png/UtlXZ9UDt5902H3fVwhwhzVarcDpDJ2czPG6PuJCu5YUrlzgXqJIAEmCMjIKzGrQ2C6Eo638auDHpzunDPLBaQ/640?wx_fmt=png&from=appmsg",src:"https://mmbiz.qpic.cn/sz_mmbiz_png/UtlXZ9UDt5902H3fVwhwhzVarcDpDJ2czPG6PuJCu5YUrlzgXqJIAEmCMjIKzGrQ2C6Eo638auDHpzunDPLBaQ/640?wx_fmt=png&from=appmsg"}})])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{"word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px","line-height":"26px",color:"black",visibility:"visible"},attrs:{leaf:""}},[t._v("编")]),i("span",{staticStyle:{"word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px","line-height":"26px",color:"black",visibility:"visible"},attrs:{leaf:""}},[t._v("程语言细节往往隐藏着意想不到的陷阱。今天笔者与AI共同排查了一个教科书级别的生产环境问题，从原")]),i("span",{staticStyle:{"word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px","line-height":"26px",color:"black",visibility:"visible"},attrs:{leaf:""}},[t._v("理看不复杂，它揭示了一些入门Python垃圾回收机制，但在快速迭代的代码中容易被忽略。"),i("span",{staticStyle:{"font-weight":"bold",visibility:"visible"},attrs:{textstyle:""}},[t._v("笔者主要想展示： 在AI辅助编程定位问题方面的实验")]),t._v('。正如我之前提到的，"笔者长期在cursor/windsurf之间徘徊"，这次排查过程中，'),i("span",{staticStyle:{"font-weight":"bold",visibility:"visible"},attrs:{textstyle:""}},[t._v("AI工具的分析能力和协作效率非常")])]),i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[i("span",{staticStyle:{"font-weight":"bold",visibility:"visible"},attrs:{textstyle:""}},[t._v("重要。")])])]),i("h2",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"22px",visibility:"visible"}},[i("span",{staticStyle:{display:"none"}}),i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("问题描述")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v('批量处理任务时偶现获取血缘数据关系失败，4月底某同学定位到图数据库连接限制错误("too many connections")，说明任务未正确释放资源。')])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("随后其他同学修复版本1（2x.x.x）：在数据库连接底层增加全局实例、复用全局实例，限制最大连接数量。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("04-29上线后，数量有限的批处理任务下，未发现异常。04-30下午6点开始处理大批量任务时，执行一段时间后，开始出现数据库报错。后台反馈连接超过最大限制，于是停止服务。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("奇怪的是，旧版本能处理大批量任务(20万条)且正常获取血缘数据关系。")])]),i("h2",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"22px",visibility:"visible"}},[i("span",{staticStyle:{display:"none"}}),i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("真正的原因和解决方案")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("代码架构变化导致Python垃圾回收机制行为差异：")])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc",visibility:"visible"}},[i("li",{staticStyle:{visibility:"visible"}},[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1, 1, 1)","font-weight":"500",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("原始版本：函数结束→agent变量引用计数减少→垃圾回收更及时")])])]),i("li",{staticStyle:{visibility:"visible"}},[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1, 1, 1)","font-weight":"500",visibility:"visible"}},[i("span",{staticStyle:{visibility:"visible"},attrs:{leaf:""}},[t._v("新版本：agent对象在函数间传递→引用计数延迟减少→垃圾回收更晚触发")])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("本质问题：批量任务会导致大量外部资源（数据库连接）积累，一个版本使用了局部函数，会及时触发垃圾回收自动清理。而后续版本释放时机不可靠，取决于Python的GC活动。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[i("br")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("解决方案1：手动触发垃圾回收——快速解决根本问题")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("解决方案2：基于目前的代码完善数据库连接底层兼容连接复用，即使上层未释放，也能不超过最大连接限制")])]),i("h2",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"22px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("定位过程")])]),i("h3",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("05-06 下午笔者尝试定位")])]),i("h3",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0px","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("——全程基于对话式沟通——")])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{attrs:{leaf:""}},[t._v("步骤1：与AI合作找到全部引用链条")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("●API——>服务层——>基础Agent——>上下文服务——>数据服务——>数据库服务")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("●批量服务——>服务层——>基础Agent——>上下文服务——>数据服务——>数据库服务")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("人思考1：排除API服务导致，因为生成API调用量少。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("AI观察：批量创建服务，每次都会沿着调用链条创建数据库链接，确实没有主动释放链接的代码。")])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("步骤2：和AI探索修复版本1（2x.x.x）为何无效？")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("AI思考：全局实例 != 唯一连接，一个实例可能创建N个链接，所以这个修改并未解决问题。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v('人思考：纠结数据库如何从底层"兼容"控制连接复用，错误重试等没意义，因为我们最初的版本是正常的，那个时候，图数据库服务非常简单，不需要全局管理，也不需要复杂的处理。说明问题本是【某个版本上层代码或者架构变化导致】，那才是根源。')])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("步骤3：切换到一个月前的版本并观察")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("AI思考：批量创建服务，每次都会沿着调用链条创建数据库链接，确实没有主动释放链接的代码。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("从代码看，没有释放连接的问题依旧存在。但为何之前正常？")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("人思考：如果从代码上确实存在批量创建Agent和数据库连接，那可能是释放的问题，也许旧代码可以自动释放，而新代码无法自动释放，什么情况下连接会自动释放——Python的垃圾回收？")])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("步骤4：让AI编写测试脚本尝试复现")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("编写几个测试脚本（3 个文件大概")]),i("span",{attrs:{leaf:""}},[t._v("总1000行），完整地模拟整个流程：服务层——>基础Agent——>上下文服务——>数据服务——>数据库服务。")])]),i("ol",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"decimal"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("无主动触发垃圾回收，循环300+的任务，打印观察数据库连接数")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("主动触发垃圾回收，循环300+任务, 打印观察")])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("观察1：连接数不断增加，超过300，触发限流错误——✅正确复现生产错误。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("观察2：连接数会不断被GC回收，永远不会超过1，不会累积——✅找到正确修复方案。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("至此，已经确定了原因和修复方案。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("继续思考：为何之前正常呢？")])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("步骤5：切换到更早的代码")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("让AI观察更早的代码和上一个版本的服务层差异。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("发现根本性问题：")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("更早的代码中，批量调用的时候在一个局部函数中，类似如下：")])]),i("section",{staticClass:"code-snippet__fix code-snippet__js"},[i("ul",{staticClass:"code-snippet__line-index code-snippet__js"},[i("li"),i("li"),i("li"),i("li"),i("li"),i("li")]),i("pre",{staticClass:"code-snippet__js"},[i("code",[i("span",{attrs:{leaf:""}},[t._v("ounter(lineounter(lineounter(lineounter(lineounter(line")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__comment"},[t._v("# 早期版本(工作正常)")])])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__keyword"},[t._v("def")]),t._v(" "),i("span",{staticClass:"code-snippet__title"},[t._v("process_inference_task")]),t._v("("),i("span",{staticClass:"code-snippet__params"},[t._v("...")]),t._v("):")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    agent = create_agent(...)  "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 局部变量")])])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    result = agent.generate(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 函数结束，agent立即失去引用")])])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("当函数结束时，其局部变量引用计数减少。如果函数没有return变量，这些变量的引用计数可能立即降为0，使它们成为优先回收对象。在我们的场景会自动触发数据库连接的结束。")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("而后续的版本架构调整，代码类似如下：")])]),i("section",{staticClass:"code-snippet__fix code-snippet__js"},[i("ul",{staticClass:"code-snippet__line-index code-snippet__js"},[i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li")]),i("pre",{staticClass:"code-snippet__js"},[i("code",[i("span",{attrs:{leaf:""}},[t._v("ounter(lineounter(lineounter(lineounter(lineounter(lineounter(lineounter(lineounter(lineounter(line")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__comment"},[t._v("# 新版本(25.3.4)(连接泄漏)")])])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__keyword"},[t._v("def")]),t._v(" "),i("span",{staticClass:"code-snippet__title"},[t._v("_execute_agent")]),t._v("("),i("span",{staticClass:"code-snippet__params"},[t._v("...")]),t._v("):")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    agent = create_agent(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    result = agent.generate(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__keyword"},[t._v("return")]),t._v(" result, confidence, agent  "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 返回agent对象")])])]),i("code",[i("span",{attrs:{leaf:""}},[i("br")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__keyword"},[t._v("def")]),t._v(" "),i("span",{staticClass:"code-snippet__title"},[t._v("process_inference_task")]),t._v("("),i("span",{staticClass:"code-snippet__params"},[t._v("...")]),t._v("):")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    result, confidence, agent = _execute_agent(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__comment"},[t._v("# agent引用延长生命周期")])])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v('创建"模拟原始版本"测试，在函数内创建和使用agent。 测试结果显示：函数局部变量模式下处理310个任务，连接数始终为0。 这解释了为什么早期版本能处理大批量任务而不触发连接限制。')])]),i("h2",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"22px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("技术分析")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("Python垃圾回收系统由两个核心机制组成：")])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("1. 引用计数(主要机制)")]),i("span",{staticStyle:{display:"none"}})]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("每个对象维护一个引用计数器")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("引用+1：赋值给变量、作为参数传递、添加到容器、作为返回值等")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("引用-1：变量超出作用域、重新赋值、del语句、容器删除等")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("当引用计数降为0时，对象")]),i("strong",{staticStyle:{"font-weight":"bold",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("立即")])]),i("span",{attrs:{leaf:""}},[t._v("回收")])])])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("2. 循环引用回收(辅助机制)")]),i("span",{staticStyle:{display:"none"}})]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("通过分代收集(generational collection)算法处理循环引用")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("三代对象池，根据对象存活时间分类")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("触发时机：")])])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"square"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("创建/销毁对象数量达到阈值时(默认700)")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("手动调用gc.collect()")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("内存压力大时")])])])])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("原版本(局部变量模式)与新版本(返回值模式)比较")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("原版本垃圾回收行为：")])]),i("section",{staticClass:"code-snippet__fix code-snippet__js"},[i("ul",{staticClass:"code-snippet__line-index code-snippet__js"},[i("li"),i("li"),i("li"),i("li"),i("li"),i("li")]),i("pre",{staticClass:"code-snippet__js"},[i("code",[i("span",{attrs:{leaf:""}},[t._v("ounter(lineounter(lineounter(lineounter(lineounter(line")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__keyword"},[t._v("def")]),t._v(" "),i("span",{staticClass:"code-snippet__title"},[t._v("process_inference_task")]),t._v("("),i("span",{staticClass:"code-snippet__params"},[t._v("...")]),t._v("):")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    agent = create_agent(...)  "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 引用计数=1")])])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    result = agent.generate(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 函数结束，agent引用计数-1变为0")])])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 立即被回收，数据库连接关闭")])])])])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("引用计数降为0立即回收")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("每个任务处理后连接立即释放")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("连接数趋近于0，不会积累")])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("新版本垃圾回收行为：")])]),i("section",{staticClass:"code-snippet__fix code-snippet__js"},[i("ul",{staticClass:"code-snippet__line-index code-snippet__js"},[i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li"),i("li")]),i("pre",{staticClass:"code-snippet__js"},[i("code",[i("span",{attrs:{leaf:""}},[t._v("ounter(lineounter(lineounter(lineounter(lineounter(lineounter(lineounter(lineounter(line")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__keyword"},[t._v("def")]),t._v(" "),i("span",{staticClass:"code-snippet__title"},[t._v("_execute_agent")]),t._v("("),i("span",{staticClass:"code-snippet__params"},[t._v("...")]),t._v("):")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    agent = create_agent(...)  "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 引用计数=1")])])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    result = agent.generate(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__keyword"},[t._v("return")]),t._v(" result, confidence, agent  "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 返回保持引用计数=1")])])]),i("code",[i("span",{attrs:{leaf:""}},[i("br")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__keyword"},[t._v("def")]),t._v(" "),i("span",{staticClass:"code-snippet__title"},[t._v("process_inference_task")]),t._v("("),i("span",{staticClass:"code-snippet__params"},[t._v("...")]),t._v("):")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    result, confidence, agent = _execute_agent(...)")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("    "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 只有process_inference_task结束时引用计数才-1")])])])])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("对象引用计数延迟到外层函数结束才减少")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("多个处理任务期间，对象引用一直存在")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("连接积累到一定规模才会触发垃圾回收")])])])]),i("h3",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"20px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("垃圾回收触发阈值与偶发性问题解释")]),i("span",{staticStyle:{display:"none"}})]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("Python垃圾回收阈值通过以下参数控制：")])]),i("section",{staticClass:"code-snippet__fix code-snippet__js"},[i("ul",{staticClass:"code-snippet__line-index code-snippet__js"},[i("li"),i("li"),i("li"),i("li")]),i("pre",{staticClass:"code-snippet__js"},[i("code",[i("span",{attrs:{leaf:""}},[t._v("ounter(lineounter(lineounter(line")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__meta"},[t._v(">>> ")]),i("span",{staticClass:"code-snippet__keyword"},[t._v("import")]),t._v(" gc")])]),i("code",[i("span",{attrs:{leaf:""}},[i("span",{staticClass:"code-snippet__meta"},[t._v(">>> ")]),t._v("gc.get_threshold()")])]),i("code",[i("span",{attrs:{leaf:""}},[t._v("("),i("span",{staticClass:"code-snippet__number"},[t._v("700")]),t._v(", "),i("span",{staticClass:"code-snippet__number"},[t._v("10")]),t._v(", "),i("span",{staticClass:"code-snippet__number"},[t._v("10")]),t._v(")  "),i("span",{staticClass:"code-snippet__comment"},[t._v("# 典型默认值")])])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("意味着：")])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("创建700个新对象后，触发第0代回收")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("10次0代回收后，触发1代回收")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("10次1代回收后，触发2代回收")])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("在批处理环境中：")])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("如果批量小于700：可能不会触发垃圾回收")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("如果内存足够：即使超过700后触发回收，但低优先级对象可能稍后才被回收")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("如果服务器负载变化：垃圾回收频率受影响，导致偶发问题")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("并发任务：多个并发任务可能更快达到连接限制(300)")])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("这完美解释了")]),i("strong",{staticStyle:{"font-weight":"bold",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("偶发性问题")])]),i("span",{attrs:{leaf:""}},[t._v("：在不同的服务器负载、内存压力和并发级别下，垃圾回收触发时机不同，某些情况下会在达到连接限制前回收资源，而某些情况下不会。")])]),i("h2",{staticStyle:{"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"22px"}},[i("span",{staticStyle:{display:"none"}}),i("span",{attrs:{leaf:""}},[t._v("技术总结")])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("问题是Python垃圾回收时机与外部资源限制之间的竞争：")])]),i("ul",{staticClass:"list-paddingleft-1",staticStyle:{"margin-top":"8px","margin-bottom":"8px","padding-left":"25px",color:"black","list-style-type":"disc"}},[i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("早期版本：引用计数机制保证连接及时释放")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("新版本：依赖周期性垃圾回收，但连接积累速度可能超过回收速度")])])]),i("li",[i("section",{staticStyle:{"margin-top":"5px","margin-bottom":"5px","line-height":"26px","text-align":"left",color:"rgb(1,1,1)","font-weight":"500"}},[i("span",{attrs:{leaf:""}},[t._v("阈值导致的不确定性：在不同环境下，垃圾回收的触发点不同")])])])]),i("p",{staticStyle:{"font-size":"16px","padding-top":"8px","padding-bottom":"8px",margin:"0","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("这是依赖垃圾回收管理外部有限资源的典型陷阱，解决方案必须采用确定性的资源释放策略，而非依赖垃圾回收的不确定行为。")])])]),i("section",[i("span",{attrs:{leaf:""}},[i("br")])]),i("section",{staticStyle:{"line-height":"1.6","word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"margin-top":"30px","margin-bottom":"15px",padding:"0px","font-weight":"bold",color:"black","font-size":"22px"}},[i("span",{attrs:{leaf:""}},[t._v("AI 协作总结")])]),i("section",{staticStyle:{padding:"8px 10px","word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px",margin:"0px","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("整体协作几乎行云流水，全部在一个对话框内完成， 包含代码生成、测试。在这里展示了两个问题：")])]),i("section",{staticStyle:{padding:"8px 10px","word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px",margin:"0px","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("1. 人的方向性非常重要，需要专业知识深度和广度支持")])]),i("section",{staticStyle:{padding:"8px 10px","word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px",margin:"0px","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[t._v("2. AI 做了大量的细节工作，人不再需要关注细节，只需要理解。")])]),i("section",{staticStyle:{padding:"8px 10px","word-spacing":"0px","letter-spacing":"0px","word-break":"break-word","overflow-wrap":"break-word","text-align":"left","font-family":'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',"font-size":"16px",margin:"0px","line-height":"26px",color:"black"}},[i("span",{attrs:{leaf:""}},[i("br")])]),i("p",{staticStyle:{display:"none"}},[i("mp-style-type")],1),t._v(" "),i("hr"),t._v(" "),i("div",{staticClass:"original-link",staticStyle:{"margin-top":"20px",padding:"10px","background-color":"#f8f8f8","border-radius":"6px"}},[i("p",{staticStyle:{margin:"0","font-size":"14px"}},[t._v("⚠️ 本文自动同步自公众号，排版可能异常，其包含图片、视频内容可能无法正常显示和播放。")]),t._v(" "),i("p",{staticStyle:{margin:"5px 0 0","font-size":"14px"}},[t._v("原文链接："),i("a",{attrs:{href:"https://mp.weixin.qq.com/s/7EN-SqD_6VelWEa7UivuDA?token=1914505798&lang=zh_CN",target:"_blank",rel:"noopener noreferrer"}},[t._v("点击查看微信公众号原文")])])])])}),[],!1,null,null,null);i.default=n.exports}}]);